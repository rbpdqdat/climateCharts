<html>
<head>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>
</head>
<body>
<script>
var stnId = "APA";
var tday = new Date();
var today = new Date(tday.getTime() + 155*86400000);
var dd = today.getDate();
var mm = today.getMonth()+1; //January is 0!
var yyyy = today.getFullYear();
var lastyear = new Date(today.getTime() - 365*86400000);
console.log(lastyear);
var ldd = lastyear.getDate();
var lmm = lastyear.getMonth()+1;
var lyyyy= lastyear.getFullYear();

//var firstDate = new Date(yyyy,00,01);
var firstDate = new Date(lyyyy,lmm,ldd);
var lastDate = new Date(yyyy,mm,dd);

var oneDay = 24*60*60*1000;

var edate = yyyy+'-'+mm+'-'+dd;
var sdate = lyyyy+'-1-1';

$(getMaxDays);
$(getRecordMaxDays);

function postError() {
    alert("oops, error");
}

function getData(url, params) {
    var xdr, args, results,
        params_string = JSON.stringify(params);
    if (window.XDomainRequest) {
        xdr = new XDomainRequest();
        xdr.open("GET", url + "?params=" +    params_string);
        xdr.onload = function () {
            results = $.parseJSON(xdr.responseText);
            processResult(results);
        };
        xdr.onerror = postError;
        xdr.onprogress = $.noop();
        xdr.ontimeout = $.noop();
        setTimeout(function () {
            xdr.send();
        }, 0);
    } else {
        args = {params: params_string};
        $.ajax(url, {
            type: 'POST',
            data: args,
            crossDomain: true,
            success: processResult,
            error: postError
        });
    }
}

function getMaxDays(){
	var url='http://data.rcc-acis.org/StnData';
	var params = {"elems":[{"name":"maxt"},{"name":"mint"},
                     {"name":"maxt","duration":"dly","normal":"1","prec":1},
                     {"name":"mint","duration":"dly","normal":"1","prec":1}],
                      "sid":"DENthr 9","sDate":"2015-01-01","eDate":"2015-12-31"
                     }
	getData(url,params);
}

function getRecordMaxDays(){
        var url='http://data.rcc-acis.org/StnData';
        var params= {"elems":[{"name":"maxt","interval":"dly","duration":"dly",
                     "smry":{"reduce":"max","add":"date"},"smry_only":1,
                     "groupby":["year","01-01","12-31"]},{"name":"mint","interval":"dly","duration":"dly","smry"
                     :{"reduce":"min","add":"date"},"smry_only":1,"groupby":["year","01-01","12-31"]}],"sid":"DENthr 9","sDate":"por"
                     ,"eDate":"por","meta":["name","state","valid_daterange","sids"]}
                     //,"meta":["name","state","valid_daterange","sids"]}
        getData(url,params);
}

function processResult(data){
        if (typeof data.data == 'undefined') { 
		alert('Station is invalid or has no data.  Try another station (eg. HOU).');
	}
        else {
	var sum = new Array();
	var titleName = "Growing Degree Days (Base 50\u00B0F)";
	var gdd = new Array();
	for(var i=0;i<data.data.length;i++){
		if(data.data[i][1] === "M"){gdd[i] = null;} //if the data is missing it will not show the data value.  
		else{gdd[i] = parseInt(data.data[i][1],10);}
		if(i==0){sum[i] = gdd[i];}
		else{sum[i] = sum[i-1] + gdd[i];}
	}
	$('#output').highcharts({
		chart:{
                	zoomType: 'x'
                },
               	title:{
                        text: titleName
                },
                subtitle:{
                	text: data.meta.name + " (" + data.meta.state + ")",
                        style: {
                        	fontSize: '14px'
                        }
                },
                xAxis:{
                	type: 'datetime',
                        maxZoom: 3 * 24 * 3600000,
                       	labels: {
                        	style: {
                                	color: '#000000',
                                        fontSize: '14px'
                                }
                        }
                },
                yAxis:[{
                	title:{
                        	text: 'Growing Degree Days',
                                style: {
                        	        fontSize: '14px'
                               },
                        },
                        labels: {
                        	style: {
                                	color: '#000000'
                                }
                        }
               	},{
                        title:{
                        	text: 'Accumulated Growing Degree Days',
                                style: {
                                	color: '#F00000',
                                	fontSize: '14px'
                                },
                        },
                        labels: {
				style: {
                                color: '#000000'
                        }
                },
                        min: 0,
                        opposite: true
                }],
                tooltip:{
                        shared: true,
                        crosshairs: true
                },
                credits:{
                        text: 'Click and drag to zoom',
                        href: 'http://www.rcc-acis.org/'
                },
                plotOptions: {
                        series: {
                	        marker: {
               		                enabled: false
                                }
                        }
                },
                series:[{
                        name: 'Growing Degree Days',
                        color: '#0404B4',
                        type: 'line',
                        data: gdd,
                        pointStart: Date.UTC(yyyy,00,01),
                        pointInterval: 24 * 3600 * 1000
                },{
                        name: 'Accumulated Growing Degree Days',
                        color: '#F00000',
                        yAxis: 1,
                        type: 'line',
                        data: sum,
                        pointStart: Date.UTC(yyyy,00,01),
                        pointInterval: 24 * 3600 * 1000
                }]

	});

	}
}
</script>
<div id="output" style="width:800px;height:500px"></div>
</body>
</html>
